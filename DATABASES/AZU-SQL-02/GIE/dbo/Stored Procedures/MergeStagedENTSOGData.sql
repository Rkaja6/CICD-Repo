CREATE PROCEDURE dbo.MergeStagedENTSOGData AS
MERGE [dbo].[OperationalData] dest
USING
(
SELECT
[id]
      ,[dataSet]
      ,[indicator]
      ,[periodType]
      ,[periodFrom]
      ,[periodTo]
      ,[operatorKey]
      ,[tsoEicCode]
      ,[operatorLabel]
      ,[pointKey]
      ,[pointLabel]
      ,[tsoItemIdentifier]
      ,[directionKey]
      ,[unit]
      ,[itemRemarks]
      ,[generalRemarks]
      ,[value]
      ,[lastUpdateDateTime]
      ,[isUnlimited]
      ,[flowStatus]
      ,[interruptionType]
      ,[restorationInformation]
      ,[capacityType]
      ,[capacityBookingStatus]
      ,[isCamRelevant]
      ,[isNA]
      ,[originalPeriodFrom]
      ,[isCmpRelevant]
      ,[bookingPlatformKey]
      ,[bookingPlatformLabel]
      ,[bookingPlatformURL]
FROM
(SELECT
[id]
      ,[dataSet]
      ,[indicator]
      ,[periodType]
      ,[periodFrom]
      ,[periodTo]
      ,[operatorKey]
      ,[tsoEicCode]
      ,[operatorLabel]
      ,[pointKey]
      ,[pointLabel]
      ,[tsoItemIdentifier]
      ,[directionKey]
      ,[unit]
      ,[itemRemarks]
      ,[generalRemarks]
      ,[value]
      ,[lastUpdateDateTime]
      ,[isUnlimited]
      ,[flowStatus]
      ,[interruptionType]
      ,[restorationInformation]
      ,[capacityType]
      ,[capacityBookingStatus]
      ,[isCamRelevant]
      ,[isNA]
      ,[originalPeriodFrom]
      ,[isCmpRelevant]
      ,[bookingPlatformKey]
      ,[bookingPlatformLabel]
      ,[bookingPlatformURL],
ROW_NUMBER() OVER (PARTITION BY id ORDER BY CONVERT(DATETIME, lastUpdateDateTime) DESC) seq 
  FROM [GIE].[dbo].[OperationalDataStage]) a
WHERE seq = 1) source
ON
dest.id = source.id
WHEN NOT MATCHED THEN
INSERT
(
[id]
      ,[dataSet]
      ,[indicator]
      ,[periodType]
      ,[periodFrom]
      ,[periodTo]
      ,[operatorKey]
      ,[tsoEicCode]
      ,[operatorLabel]
      ,[pointKey]
      ,[pointLabel]
      ,[tsoItemIdentifier]
      ,[directionKey]
      ,[unit]
      ,[itemRemarks]
      ,[generalRemarks]
      ,[value]
      ,[lastUpdateDateTime]
      ,[isUnlimited]
      ,[flowStatus]
      ,[interruptionType]
      ,[restorationInformation]
      ,[capacityType]
      ,[capacityBookingStatus]
      ,[isCamRelevant]
      ,[isNA]
      ,[originalPeriodFrom]
      ,[isCmpRelevant]
      ,[bookingPlatformKey]
      ,[bookingPlatformLabel]
      ,[bookingPlatformURL]
)
VALUES
(
source.[id]
      ,source.[dataSet]
      ,source.[indicator]
      ,source.[periodType]
      ,source.[periodFrom]
      ,source.[periodTo]
      ,source.[operatorKey]
      ,source.[tsoEicCode]
      ,source.[operatorLabel]
      ,source.[pointKey]
      ,source.[pointLabel]
      ,source.[tsoItemIdentifier]
      ,source.[directionKey]
      ,source.[unit]
      ,source.[itemRemarks]
      ,source.[generalRemarks]
      ,source.[value]
      ,source.[lastUpdateDateTime]
      ,source.[isUnlimited]
      ,source.[flowStatus]
      ,source.[interruptionType]
      ,source.[restorationInformation]
      ,source.[capacityType]
      ,source.[capacityBookingStatus]
      ,source.[isCamRelevant]
      ,source.[isNA]
      ,source.[originalPeriodFrom]
      ,source.[isCmpRelevant]
      ,source.[bookingPlatformKey]
      ,source.[bookingPlatformLabel]
      ,source.[bookingPlatformURL]
);